<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mybatis.board">
	<select id="getBoardList" parameterType="map" resultType="map">
		SELECT BM.BM_NO, BM.BM_TITLE, BM.BM_WRITER, BM.BM_DATE, BM.BM_HIT, NVL (BS.BS_FILE, '없음') BS_FILE FROM
		BOARD_MASTER_T BM LEFT OUTER JOIN BOARD_SUB_T BS ON BM.BM_NO = BS.BM_NO
		<if test="cb_search != null and cb_search.equals('bm_title')">
			AND BM.BM_TITLE LIKE '%'||#{tb_search}||'%'
		</if>
		ORDER BY BM_NO DESC<!-- , BM_GROUP DESC, BM_STEP ASC -->
	</select>

	<select id="getBoardSub" parameterType="map" resultType="map">
		SELECT * FROM BOARD_SUB_T
	</select>

	<select id="getBmno" resultType="int">
		SELECT NVL ((SELECT /*+INDEX_DESC(BOARD_MASTER_T BOARD_MNO_PK)*/ BM_NO FROM BOARD_MASTER_T WHERE ROWNUM = 1)
		,0) + 1 BM_NO FROM DUAL
	</select>

	<select id="getGroup" resultType="int">
		SELECT NVL ((SELECT /*+INDEX_DESC(BOARD_MASTER_T I_GROUP)*/ BM_GROUP FROM BOARD_MASTER_T WHERE ROWNUM = 1
		AND
		BM_GROUP > 0) ,0) + 1 BM_GROUP FROM DUAL
	</select>

	<select id="getBsseq" resultType="int">
		SELECT COUNT (BS_SEQ) FROM BOARD_SUB_T
	</select>

	<insert id="boardInsert" parameterType="map">
		INSERT INTO BOARD_MASTER_T (BM_NO, BM_TITLE, BM_WRITER, BM_DATE, BM_EMAIL, BM_CONTENT, BM_GROUP,
		BM_POS, BM_STEP, BM_PW, BM_HIT) VALUES (#{bm_no}, #{bm_title}, #{bm_writer}, TO_CHAR (SYSDATE, 'YYYY-MM-DD HH24:MI:SS'), #{bm_email}, #{bm_content},
		0, 0, 0, #{bm_pw}, 0)
	</insert>

	<insert id="boardFileInsert" parameterType="map">
		INSERT INTO BOARD_SUB_T (BM_NO, BS_SEQ, BS_FILE) VALUES (#{bm_no}, #{bs_seq}, #{bs_file})
	</insert>

	<update id="hitCount" parameterType="int">
		UPDATE BOARD_MASTER_T
		SET BM_HIT = BM_HIT + 1
		WHERE BM_NO = #{value}
	</update>

	<update id="bmStepUpdate" parameterType="map">
		UPDATE BOARD_MASTER_T SET BM_STEP = BM_STEP + 1
		WHERE BM_GROUP = #{bm_group}
		<![CDATA[ AND BM_STEP > #{bm_step}]]>
	</update>

	<delete id="boardMDelete" parameterType="map">
		DELETE FROM BOARD_MASTER_T
		WHERE BM_NO = #{BM_NO}
	</delete>

	<delete id="boardSDelete" parameterType="map">
		DELETE FROM BOARD_SUB_T
		WHERE BM_NO = #{BM_NO}
	</delete>
</mapper>